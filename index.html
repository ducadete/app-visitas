<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gest√£o de Pacientes Mobile</title>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- jsPDF for PDF Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

    :root {
      --primary-color:#0056b3; --primary-light:#e7f3ff; --secondary-color:#28a745;
      --danger-color:#dc3545; --info-color:#17a2b8; --warning-color:#ffc107;
      --grey-light:#f8f9fa; --grey-medium:#dee2e6; --grey-dark:#6c757d;
      --text-color:#333; --bg-color:#f0f2f5;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;overflow:hidden}
    body{font-family:'Roboto',sans-serif;background-color:var(--bg-color);color:var(--text-color);-webkit-tap-highlight-color:transparent}

    #login-view{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;padding:20px;background-color:var(--primary-color)}
    .login-box{width:100%;max-width:320px;padding:30px;background:#fff;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,.15);text-align:center}
    .login-box h1{color:var(--primary-color);margin-bottom:25px;font-size:24px}
    .login-box .form-group{margin-bottom:20px;text-align:left}
    .login-box input{width:100%;padding:12px;font-size:16px;border:1px solid var(--grey-medium);border-radius:8px;background:#fff}
    #login-error{color:var(--danger-color);margin-top:15px;font-size:14px;height:20px}

    .main-container{display:none;flex-direction:column;height:100%;width:100%;overflow:hidden;position:relative}
    .view{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;transition:transform .3s ease-in-out;background:var(--bg-color)}
    #list-view{transform:translateX(0);z-index:10}
    #details-view{transform:translateX(100%);z-index:20}
    .main-container.show-details #list-view{transform:translateX(-100%)}
    .main-container.show-details #details-view{transform:translateX(0)}

    .main-header{background:#fff;padding:12px 16px;border-bottom:1px solid var(--grey-medium);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
    .main-header h1{margin:0;font-size:18px;color:var(--primary-color);text-overflow:ellipsis;white-space:nowrap;overflow:hidden}
    .header-actions{display:flex;gap:8px}
    .btn-icon{background:none;border:none;cursor:pointer;padding:8px;color:var(--grey-dark)}

    .btn{padding:12px 18px;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;transition:.2s;color:#fff;text-align:center;width:100%}
    .btn:disabled{background:var(--grey-medium);cursor:not-allowed}
    .btn-success{background:var(--secondary-color)}
    .btn-info{background:var(--info-color)}
    .btn-danger{background:var(--danger-color)}
    .btn-primary{background:var(--primary-color)}

    .list-controls{padding:12px;background:#fff;border-bottom:1px solid var(--grey-medium);display:flex;flex-direction:column;gap:10px}
    .list-controls input,.list-controls select{width:100%;padding:12px;font-size:16px;border:1px solid var(--grey-medium);border-radius:8px}
    .team-tabs{display:flex;border-bottom:1px solid var(--grey-medium);background:#fff}
    .tab{flex-grow:1;padding:14px 8px;text-align:center;cursor:pointer;color:var(--grey-dark);font-weight:500;border-bottom:3px solid transparent}
    .tab.active{color:var(--primary-color);border-bottom-color:var(--primary-color)}
    #patient-list{list-style:none;overflow-y:auto;flex-grow:1}
    #patient-list li{padding:16px;border-bottom:1px solid var(--grey-medium);cursor:pointer;background:#fff}
    #patient-list li .patient-name{font-weight:700;font-size:16px}
    #patient-list li .patient-status{font-size:14px;color:var(--grey-dark);margin-top:4px}
    #patient-list li.overdue .patient-name{color:var(--danger-color)}
    .fab-container{position:absolute;bottom:20px;right:20px;z-index:15}
    .fab{background:var(--secondary-color);color:#fff;width:56px;height:56px;border-radius:50%;border:none;font-size:28px;display:flex;justify-content:center;align-items:center;box-shadow:0 4px 12px rgba(0,0,0,.2);cursor:pointer}

    #details-panel{flex-grow:1;overflow-y:auto;padding:16px}
    .patient-card{background:#fff;border-radius:12px;padding:16px}
    .card-header{padding-bottom:16px;margin-bottom:16px;border-bottom:1px solid var(--grey-medium)}
    .card-header h3{font-size:20px;margin-bottom:8px}
    .overdue-alert{color:var(--danger-color);font-weight:bold;font-size:14px}
    .card-section{margin-bottom:20px}
    .card-section h4{font-size:14px;text-transform:uppercase;font-weight:700;color:var(--primary-color);margin-bottom:8px}
    .card-section p,.tag-container{line-height:1.6}
    .section-header-with-action{display:flex;justify-content:space-between;align-items:center}
    .grid-2-cols{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .visits-section h4,.attachments-section h4{display:flex;justify-content:space-between;align-items:center}
    .visits-section .btn,.attachments-section .btn-label{font-size:14px;padding:8px 12px}
    #visits-list,#attachments-list{list-style:none;margin-top:10px}
    .visit-item{background:var(--grey-light);border-radius:8px;padding:12px;margin-bottom:10px;border-left:4px solid var(--info-color)}
    .visit-header{display:flex;justify-content:space-between;font-weight:700}
    .visit-details{margin-top:8px;font-size:14px}
    .tag-container{display:flex;flex-wrap:wrap;gap:8px}
    .tag-item{background:var(--primary-color);color:#fff;padding:5px 12px;border-radius:16px;font-size:14px}

    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg-color);z-index:1000;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .3s}
    .modal-overlay.visible{transform:translateY(0)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#fff;border-bottom:1px solid var(--grey-medium);flex-shrink:0}
    .modal-header h2{font-size:18px}
    .modal-body{padding:16px;overflow-y:auto;flex-grow:1}
    .form-group{display:flex;flex-direction:column;margin-bottom:16px}
    .form-group label{margin-bottom:8px;font-weight:500;font-size:14px}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;font-size:16px;border:1px solid var(--grey-medium);border-radius:8px;background:#fff}
    .form-group textarea{min-height:80px}
    .modal-footer{padding:16px;background:#fff;border-top:1px solid var(--grey-medium);display:flex;gap:10px;flex-shrink:0}
    
    .tag-input-container { display: flex; flex-wrap: wrap; gap: 8px; padding: 8px; border: 1px solid var(--grey-medium); border-radius: 8px; background: #fff; margin-bottom: 8px; min-height: 40px; }
    .tag-input-item { background: var(--primary-color); color: #fff; padding: 5px 10px; border-radius: 16px; font-size: 14px; display: flex; align-items: center; gap: 6px; }
    .remove-tag-btn { background: none; border: none; color: #fff; cursor: pointer; font-weight: bold; font-size: 16px; padding: 0; line-height: 1; }
    .suggestions-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .suggestion-btn { background: var(--grey-light); border: 1px solid var(--grey-medium); color: var(--text-color); padding: 5px 12px; border-radius: 16px; font-size: 12px; cursor: pointer; }
    .suggestion-btn:hover { background: var(--primary-light); border-color: var(--primary-color); }

    .notification-bell{position:relative}
    .bell-icon{width:24px;height:24px}
    .notification-badge{position:absolute;top:-4px;right:-6px;background:var(--danger-color);color:#fff;border-radius:50%;width:18px;height:18px;font-size:11px;display:flex;justify-content:center;align-items:center;font-weight:bold;border:2px solid #fff}
    #notification-panel{position:absolute;top:55px;right:10px;width:calc(100% - 20px);max-width:320px;max-height:400px;overflow-y:auto;background:#fff;border:1px solid var(--grey-medium);border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,.1);z-index:1100}
    .notification-item{padding:12px;border-bottom:1px solid #eee;cursor:pointer}
    .notification-item:hover{background:var(--grey-light)}
    .notification-item p{margin:0;font-size:14px}
    .notification-item .patient-name{font-weight:bold}
    .notification-item .overdue-date{font-size:12px;color:var(--danger-color)}
    .hidden{display:none!important}

    .form-group-with-icon { position: relative; }
    .mic-btn {
        position: absolute;
        top: 32px; 
        right: 8px;
        padding: 5px;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--grey-dark);
        z-index: 10;
    }
    .mic-btn svg { width: 20px; height: 20px; }
    .mic-btn.listening svg {
        stroke: var(--danger-color);
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .message-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    .message-modal-box {
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        max-width: 320px;
        width: 100%;
        text-align: center;
    }
    .message-modal-box p {
        margin: 0 0 20px 0;
        font-size: 16px;
        line-height: 1.5;
        color: var(--text-color);
    }
    .message-modal-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    .message-modal-actions .btn {
      width: auto;
      min-width: 100px;
    }

    .atendimentos-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .atendimento-item {
        background: var(--grey-light);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        border-left: 4px solid var(--primary-color);
    }
    .atendimento-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 10px;
        margin-bottom: 10px;
        border-bottom: 1px solid var(--grey-medium);
        font-size: 14px;
        flex-wrap: wrap;
        gap: 8px;
    }
    .atendimento-header strong {
        color: var(--primary-color);
    }
    .atendimento-body .soap-section {
        margin-bottom: 12px;
    }
    .atendimento-body .soap-section:last-child {
        margin-bottom: 0;
    }
    .atendimento-body h4 {
        font-size: 13px;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 4px;
    }
    .atendimento-body p {
        font-size: 15px;
        line-height: 1.5;
        white-space: pre-wrap; 
        word-wrap: break-word;
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="login-view">
    <div class="login-box">
      <h1>Acesso Restrito</h1>
      <div class="form-group">
        <label for="email">E-mail</label>
        <input type="email" id="email" placeholder="Digite o e-mail da equipe">
      </div>
      <div class="form-group">
        <label for="password">Senha</label>
        <input type="password" id="password" placeholder="Digite sua senha">
      </div>
      <button id="login-btn" class="btn btn-primary">Entrar</button>
      <p id="login-error"></p>
    </div>
  </div>

  <div id="main-container" class="main-container">
    <!-- LISTA -->
    <div id="list-view" class="view">
      <header class="main-header">
        <h1>Acompanhamento</h1>
        <div class="header-actions">
           <button id="header-add-patient-btn" class="btn-icon" title="Cadastrar Paciente">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
           </button>
           <button id="export-btn" class="btn-icon" title="Exportar Visitas Agendadas">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
           </button>
          <button id="notification-bell" class="btn-icon notification-bell">
            <svg class="bell-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.5V11C18 7.13 14.87 4 11 4S4 7.13 4 11V16.5L2 18.5V19.5H20V18.5L18 16.5ZM11 22C12.1 22 13 21.1 13 20H9C9 21.1 9.9 22 11 22Z"/></svg>
            <div id="notification-badge" class="notification-badge hidden">0</div>
          </button>
          <button id="more-options-btn" class="btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
          </button>
        </div>
      </header>

      <div id="notification-panel" class="hidden"></div>

      <nav class="team-tabs">
        <div class="tab active" data-team="71">Equipe 71</div>
        <div class="tab" data-team="72">Equipe 72</div>
        <div class="tab" data-team="76">Equipe 76</div>
      </nav>

      <div class="list-controls">
        <input type="search" id="search-input" placeholder="Buscar por nome, CNS, telefone...">
        <select id="filter-select">
          <option value="all">Filtrar por Visita...</option>
          <option value="overdue">Visitas Atrasadas</option>
          <option value="this_month">Pr√≥xima Visita (este m√™s)</option>
          <option value="next_month">Pr√≥xima Visita (pr√≥ximo m√™s)</option>
          <option value="no_next_visit">Sem Pr√≥xima Visita</option>
        </select>
        <select id="filter-microarea-select">
          <option value="all">Filtrar por Micro√°rea...</option>
        </select>
      </div>

      <ul id="patient-list">
        <li id="list-placeholder" style="text-align:center;color:var(--grey-dark);padding:20px;">Aguardando login...</li>
      </ul>

      <div class="fab-container">
        <button id="add-patient-btn" class="fab" disabled>+</button>
      </div>
    </div>

    <!-- DETALHES -->
    <div id="details-view" class="view">
      <header class="main-header">
        <button id="back-to-list-btn" class="btn-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <h1 id="details-header-title">Detalhes do Paciente</h1>
        <div class="header-actions">
          <button id="edit-patient-btn" class="btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          </button>
          <button id="delete-patient-btn" class="btn-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
          </button>
        </div>
      </header>
      <main class="details-panel" id="details-panel">
        <div id="patient-card-container"></div>
      </main>
    </div>
  </div>

  <!-- Modais -->
  <div id="patient-modal" class="modal-overlay"></div>
  <div id="visit-modal" class="modal-overlay"></div>
  <div id="more-options-modal" class="modal-overlay"></div>
  <div id="atendimento-modal" class="modal-overlay"></div>
  <div id="atendimento-records-modal" class="modal-overlay"></div>
  <div id="export-modal" class="modal-overlay"></div>

  <script type="module">
    // ===== SUPABASE =====
    const SUPABASE_URL = 'https://jxamkxbpfrpqghlaglqs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4YW1reGJwZnJwcWdobGFnbHFzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NTM1NjYsImV4cCI6MjA3MTEyOTU2Nn0.24_ioPIQUp2b5pYhVdoEYyGgZUVSG5vjmwJ8LSkS-w4';
    const { createClient } = supabase;
    let db;

    // ===== UI ELEMENTS =====
    const loginView = document.getElementById('login-view');
    const mainContainer = document.getElementById('main-container');
    const loginBtn = document.getElementById('login-btn');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginError = document.getElementById('login-error');
    const patientListEl = document.getElementById('patient-list');
    const listPlaceholder = document.getElementById('list-placeholder');
    const teamTabs = document.querySelector('.team-tabs');
    const patientCardContainer = document.getElementById('patient-card-container');
    const addPatientBtn = document.getElementById('add-patient-btn');
    const searchInput = document.getElementById('search-input');
    const filterSelect = document.getElementById('filter-select');
    const filterMicroareaSelect = document.getElementById('filter-microarea-select');
    const notificationBell = document.getElementById('notification-bell');
    const notificationBadge = document.getElementById('notification-badge');
    const notificationPanel = document.getElementById('notification-panel');
    const patientModalContainer = document.getElementById('patient-modal');
    const visitModalContainer = document.getElementById('visit-modal');
    const moreOptionsModalContainer = document.getElementById('more-options-modal');
    const atendimentoModalContainer = document.getElementById('atendimento-modal');
    const atendimentoRecordsModalContainer = document.getElementById('atendimento-records-modal');
    const exportModalContainer = document.getElementById('export-modal');
    const backToListBtn = document.getElementById('back-to-list-btn');
    const detailsHeaderTitle = document.getElementById('details-header-title');
    const editPatientBtn = document.getElementById('edit-patient-btn');
    const deletePatientBtn = document.getElementById('delete-patient-btn');
    const moreOptionsBtn = document.getElementById('more-options-btn');
    const headerAddPatientBtn = document.getElementById('header-add-patient-btn');
    const exportBtn = document.getElementById('export-btn');

    // ===== ESTADO =====
    let allPatients = [];
    let currentTeam = '71';
    let selectedPatientId = null;
    let realtimeChannel = null;
    let recognition = null; // Speech recognition instance

    const medicationSuggestions = ['Losartana','Hidroclorotiazida','AAS','Metformina','Glibenclamida','Insulina NPH','Omeprazol','Sinvastatina','Paracetamol','Dipirona'];
    const comorbiditySuggestions = ['Hipertens√£o Arterial (HAS)','Diabetes Mellitus (DM)','DPOC','Insufici√™ncia Card√≠aca (ICC)','Doen√ßa Renal Cr√¥nica (DRC)','Sequela de AVC','Dem√™ncia / Alzheimer','Depress√£o'];

    // ===== FUN√á√ïES DE MODAL =====
    function showConfirmationModal(message, onConfirm) {
        const modalId = 'confirmation-modal-' + Date.now();
        const modalHtml = `
            <div id="${modalId}" class="message-modal-overlay">
                <div class="message-modal-box">
                    <p>${message}</p>
                    <div class="message-modal-actions">
                        <button id="cancel-btn" class="btn btn-primary">N√£o</button>
                        <button id="confirm-btn" class="btn btn-danger">Sim</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const modalElement = document.getElementById(modalId);
        
        const removeModal = () => {
            if (modalElement) modalElement.remove();
        };

        modalElement.querySelector('#confirm-btn').addEventListener('click', () => {
            onConfirm();
            removeModal();
        });
        modalElement.querySelector('#cancel-btn').addEventListener('click', removeModal);
    }

    function showMessageModal(message) {
       const modalId = 'message-modal-' + Date.now();
        const modalHtml = `
            <div id="${modalId}" class="message-modal-overlay">
                <div class="message-modal-box">
                    <p>${message}</p>
                    <div class="message-modal-actions">
                        <button id="ok-btn" class="btn btn-primary">OK</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const modalElement = document.getElementById(modalId);
        
        const removeModal = () => {
            if (modalElement) modalElement.remove();
        };

        modalElement.querySelector('#ok-btn').addEventListener('click', removeModal);
    }

    async function showPasswordPrompt(onConfirm) {
        const modalId = 'password-prompt-' + Date.now();
        const modalHtml = `
            <div id="${modalId}" class="message-modal-overlay">
                <div class="message-modal-box">
                    <h3 style="margin-bottom: 15px; color: var(--primary-color);">Acesso Restrito</h3>
                    <p>Digite a senha de acesso para m√©dicos e enfermeiros.</p>
                    <div class="form-group" style="margin-bottom: 10px; text-align: left;">
                         <input type="password" id="access-password-input" style="text-align: center;" placeholder="******">
                    </div>
                    <p id="password-error" style="color: var(--danger-color); height: 18px; font-size: 14px;"></p>
                    <div class="message-modal-actions">
                        <button id="cancel-btn" class="btn btn-danger">Cancelar</button>
                        <button id="confirm-btn" class="btn btn-success">Confirmar</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        const modalElement = document.getElementById(modalId);
        const passwordInputEl = modalElement.querySelector('#access-password-input');
        const errorEl = modalElement.querySelector('#password-error');
        
        const removeModal = () => {
            if (modalElement) modalElement.remove();
        };

        modalElement.querySelector('#confirm-btn').addEventListener('click', async () => {
            try {
                // Busca a senha do Supabase
                const { data, error } = await db
                    .from('configuracoes')
                    .select('valor')
                    .eq('chave', 'senha_medica')
                    .single();

                if (error || !data) {
                    throw new Error("N√£o foi poss√≠vel verificar a senha. Verifique a configura√ß√£o no Supabase.");
                }

                const correctPassword = data.valor;

                if (passwordInputEl.value === correctPassword) {
                    onConfirm();
                    removeModal();
                } else {
                    errorEl.textContent = 'Senha incorreta.';
                    passwordInputEl.value = '';
                    passwordInputEl.focus();
                }
            } catch (err) {
                 console.error("Erro ao verificar senha:", err);
                 errorEl.textContent = "Erro ao verificar senha.";
            }
        });

        passwordInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                 modalElement.querySelector('#confirm-btn').click();
            }
        });

        modalElement.querySelector('#cancel-btn').addEventListener('click', removeModal);
        passwordInputEl.focus();
    }
    
    // ===== FUN√á√ïES DE ATENDIMENTO (S.O.A.P) =====
    function startSpeechRecognition(textareaId, buttonElement) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            showMessageModal('Seu navegador n√£o suporta a funcionalidade de voz.');
            return;
        }

        if (recognition && recognition.isListening) {
            recognition.stop();
            return;
        }

        recognition = new SpeechRecognition();
        recognition.lang = 'pt-BR';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.isListening = false;

        const textarea = document.getElementById(textareaId);

        recognition.onstart = () => {
            recognition.isListening = true;
            buttonElement.classList.add('listening');
        };

        recognition.onend = () => {
            recognition.isListening = false;
            buttonElement.classList.remove('listening');
            recognition = null;
        };

        recognition.onerror = (event) => {
            console.error('Erro no reconhecimento de voz:', event.error);
            showMessageModal('Ocorreu um erro ao tentar usar o microfone.');
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            textarea.value += (textarea.value.length > 0 ? ' ' : '') + transcript;
        };

        recognition.start();
    }

    async function openAtendimentoForm(patientId) {
        const patient = allPatients.find(p => p.id === patientId);
        if (!patient) {
            showMessageModal('Paciente n√£o encontrado.');
            return;
        }

        atendimentoModalContainer.innerHTML = `
            <div class="modal-header">
                <h2>Atendimento Domiciliar</h2>
                <button class="btn-icon" onclick="closeAtendimentoModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;"><strong>Paciente:</strong> ${patient.nome}</p>
                <div class="form-group">
                    <label for="at_profissional">Seu Nome (Profissional)</label>
                    <input type="text" id="at_profissional" placeholder="Digite seu nome">
                </div>
                <div class="form-group form-group-with-icon">
                    <label for="at_subjetivo">Subjetivo (S)</label>
                    <button id="mic-s" class="mic-btn" onclick="startSpeechRecognition('at_subjetivo', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                    <textarea id="at_subjetivo"></textarea>
                </div>
                 <div class="form-group form-group-with-icon">
                    <label for="at_objetivo">Objetivo (O)</label>
                    <button id="mic-o" class="mic-btn" onclick="startSpeechRecognition('at_objetivo', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                    <textarea id="at_objetivo"></textarea>
                </div>
                 <div class="form-group form-group-with-icon">
                    <label for="at_avaliacao">Avalia√ß√£o (A)</label>
                     <button id="mic-a" class="mic-btn" onclick="startSpeechRecognition('at_avaliacao', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                    <textarea id="at_avaliacao"></textarea>
                </div>
                 <div class="form-group form-group-with-icon">
                    <label for="at_plano">Plano (P)</label>
                     <button id="mic-p" class="mic-btn" onclick="startSpeechRecognition('at_plano', this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                    <textarea id="at_plano"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeAtendimentoModal()">Cancelar</button>
                <button id="save-atendimento-btn" class="btn btn-success">Salvar</button>
            </div>
        `;
        atendimentoModalContainer.classList.add('visible');

        document.getElementById('save-atendimento-btn').addEventListener('click', async () => {
            const atendimentoData = {
                paciente_id: patientId,
                data_atendimento: new Date().toISOString().split('T')[0],
                subjetivo: document.getElementById('at_subjetivo').value.trim(),
                objetivo: document.getElementById('at_objetivo').value.trim(),
                avaliacao: document.getElementById('at_avaliacao').value.trim(),
                plano: document.getElementById('at_plano').value.trim(),
                profissional_nome: document.getElementById('at_profissional').value.trim()
            };

            if (!atendimentoData.profissional_nome) {
                showMessageModal('Por favor, preencha o seu nome.');
                return;
            }

            const { error } = await db.from('atendimentos').insert([atendimentoData]);

            if (error) {
                console.error('Erro ao salvar atendimento:', error);
                showMessageModal('Falha ao salvar o atendimento. Verifique se a tabela "atendimentos" foi criada corretamente no Supabase.');
            } else {
                showMessageModal('Atendimento salvo com sucesso!');
                closeAtendimentoModal();
            }
        });
    }

    function closeAtendimentoModal() {
        atendimentoModalContainer.classList.remove('visible');
        atendimentoModalContainer.innerHTML = '';
    }
    
    async function openAtendimentoRecords(patientId) {
        showPasswordPrompt(async () => {
            atendimentoRecordsModalContainer.innerHTML = `
                <div class="modal-header"><h2>Registros de Atendimento</h2></div>
                <div class="modal-body" style="text-align:center; padding: 40px;">Carregando registros...</div>
            `;
            atendimentoRecordsModalContainer.classList.add('visible');

            const { data: atendimentos, error } = await db
                .from('atendimentos')
                .select('*')
                .eq('paciente_id', patientId)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Erro ao buscar atendimentos:', error);
                showMessageModal('N√£o foi poss√≠vel carregar os registros de atendimento.');
                closeAtendimentoRecordsModal();
                return;
            }

            let recordsHtml = '<p>Nenhum atendimento registrado para este paciente.</p>';

            if (atendimentos && atendimentos.length > 0) {
                recordsHtml = atendimentos.map(at => {
                    const dataHora = new Date(at.created_at);
                    const dataFormatada = dataHora.toLocaleDateString('pt-BR');
                    const horaFormatada = dataHora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    
                    const formatContent = (text) => text ? text.replace(/\n/g, '<br>') : 'N√£o informado.';

                    return `
                        <li class="atendimento-item">
                            <div class="atendimento-header">
                                <strong>${dataFormatada} √†s ${horaFormatada}</strong>
                                <span>Por: ${at.profissional_nome || 'N/D'}</span>
                            </div>
                            <div class="atendimento-body">
                                <div class="soap-section">
                                    <h4>Subjetivo (S)</h4>
                                    <p>${formatContent(at.subjetivo)}</p>
                                </div>
                                <div class="soap-section">
                                    <h4>Objetivo (O)</h4>
                                    <p>${formatContent(at.objetivo)}</p>
                                </div>
                                <div class="soap-section">
                                    <h4>Avalia√ß√£o (A)</h4>
                                    <p>${formatContent(at.avaliacao)}</p>
                                </div>
                                <div class="soap-section">
                                    <h4>Plano (P)</h4>
                                    <p>${formatContent(at.plano)}</p>
                                </div>
                            </div>
                        </li>
                    `;
                }).join('');
            }

            const patient = allPatients.find(p => p.id === patientId);
            const patientName = patient ? patient.nome : '';

            atendimentoRecordsModalContainer.innerHTML = `
                <div class="modal-header">
                    <h2>Registros de ${patientName}</h2>
                    <button class="btn-icon" onclick="closeAtendimentoRecordsModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div class="modal-body">
                    <ul class="atendimentos-list">${recordsHtml}</ul>
                </div>
            `;
        });
    }
    
    function closeAtendimentoRecordsModal() {
        atendimentoRecordsModalContainer.classList.remove('visible');
        atendimentoRecordsModalContainer.innerHTML = '';
    }

    // ===== FUN√á√ÉO DE EXPORTA√á√ÉO PDF =====
    function openExportModal() {
        exportModalContainer.innerHTML = `
            <div class="modal-header">
                <h2>Exportar Visitas Agendadas</h2>
                <button class="btn-icon" onclick="closeExportModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Selecione os filtros para exportar as visitas agendadas.</p>
                <div class="form-group">
                    <label for="export-team-select">Equipe</label>
                    <select id="export-team-select">
                        <option value="71">Equipe 71</option>
                        <option value="72">Equipe 72</option>
                        <option value="76">Equipe 76</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="start-date">Data de In√≠cio</label>
                    <input type="date" id="start-date">
                </div>
                <div class="form-group">
                    <label for="end-date">Data de Fim</label>
                    <input type="date" id="end-date">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeExportModal()">Cancelar</button>
                <button id="generate-pdf-btn" class="btn btn-success">Gerar PDF</button>
            </div>
        `;
        exportModalContainer.classList.add('visible');
        document.getElementById('export-team-select').value = currentTeam; // Pre-select current team
        document.getElementById('generate-pdf-btn').addEventListener('click', handleExport);
    }

    function closeExportModal() {
        exportModalContainer.classList.remove('visible');
        exportModalContainer.innerHTML = '';
    }

    async function handleExport() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const selectedTeam = document.getElementById('export-team-select').value;
        const generateBtn = document.getElementById('generate-pdf-btn');

        if (!startDate || !endDate) {
            showMessageModal('Por favor, selecione a data de in√≠cio e a data de fim.');
            return;
        }
        if (new Date(startDate) > new Date(endDate)) {
            showMessageModal('A data de in√≠cio n√£o pode ser posterior √† data de fim.');
            return;
        }

        generateBtn.disabled = true;
        generateBtn.textContent = 'Gerando...';

        try {
            const { data, error } = await db
                .from('pacientes')
                .select('nome, endereco, data_proxima_visita, profissional_proxima_visita')
                .eq('equipe', selectedTeam)
                .gte('data_proxima_visita', startDate)
                .lte('data_proxima_visita', endDate)
                .order('data_proxima_visita', { ascending: true });

            if (error) throw error;

            if (!data || data.length === 0) {
                showMessageModal('Nenhuma visita agendada encontrada para o per√≠odo e equipe selecionados.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageHeight = doc.internal.pageSize.height;
            let y = 20;

            doc.setFontSize(16);
            doc.text('Relat√≥rio de Visitas Domiciliares Agendadas', 105, y, { align: 'center' });
            y += 10;
            doc.setFontSize(12);
            const startDateFormatted = new Date(startDate + 'T00:00:00').toLocaleDateString('pt-BR');
            const endDateFormatted = new Date(endDate + 'T00:00:00').toLocaleDateString('pt-BR');
            doc.text(`Equipe: ${selectedTeam} | Per√≠odo: ${startDateFormatted} a ${endDateFormatted}`, 105, y, { align: 'center' });
            y += 15;

            doc.setLineWidth(0.5);
            doc.line(10, y-5, 200, y-5);

            data.forEach(patient => {
                if (y > pageHeight - 30) {
                    doc.addPage();
                    y = 20;
                }

                const visitDate = new Date(patient.data_proxima_visita + 'T00:00:00').toLocaleDateString('pt-BR');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`Paciente: ${patient.nome || 'N√£o informado'}`, 10, y);
                y += 7;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Data da Visita: ${visitDate}`, 15, y);
                y += 6;
                doc.text(`Profissional: ${patient.profissional_proxima_visita || 'N√£o definido'}`, 15, y);
                y += 6;
                doc.text(`Endere√ßo: ${patient.endereco || 'N√£o informado'}`, 15, y);
                y += 10;
                doc.line(10, y-5, 200, y-5);
            });
            
            const fileName = `relatorio_visitas_equipe_${selectedTeam}_${startDate}_a_${endDate}.pdf`;
            doc.save(fileName);

        } catch (err) {
            console.error('Erro ao exportar dados para PDF:', err);
            showMessageModal('Ocorreu um erro ao gerar o relat√≥rio PDF. Tente novamente.');
        } finally {
            generateBtn.disabled = false;
            generateBtn.textContent = 'Gerar PDF';
            closeExportModal();
        }
    }


    // ===== FUN√á√ïES DE NOTIFICA√á√ÉO/LISTA =====
    function updateNotificationBell() {
      const now = new Date(); now.setHours(0,0,0,0);
      const overduePatients = allPatients.filter(p => p.equipe === currentTeam && p.data_proxima_visita && new Date(p.data_proxima_visita+'T00:00:00') < now);
      if (overduePatients.length > 0) {
        notificationBadge.textContent = overduePatients.length;
        notificationBadge.classList.remove('hidden');
      } else {
        notificationBadge.classList.add('hidden');
      }
    }

    function renderPatientList(patientsToRender) {
      patientListEl.innerHTML = '';
      listPlaceholder.classList.add('hidden');
      if (patientsToRender.length === 0) {
        listPlaceholder.textContent = 'Nenhum paciente encontrado.';
        listPlaceholder.classList.remove('hidden');
        patientListEl.appendChild(listPlaceholder);
        return;
      }
      patientsToRender.forEach(p => {
        const li = document.createElement('li');
        li.dataset.id = p.id;
        li.innerHTML = `<div class="patient-name">${p.nome}</div><div class="patient-status">${p.status || 'Sem status'} - Micro√°rea ${p.micro_area || 'N/D'}</div>`;
        const now = new Date(); now.setHours(0,0,0,0);
        if (p.data_proxima_visita && new Date(p.data_proxima_visita+'T00:00:00') < now) {
          li.classList.add('overdue');
        }
        li.addEventListener('click', () => handleSelectPatient(p.id));
        patientListEl.appendChild(li);
      });
    }

    function applyFiltersAndRenderList() {
      const searchTerm = searchInput.value.toLowerCase();
      const filterValue = filterSelect.value;
      const microAreaFilter = filterMicroareaSelect.value;
      let filteredPatients = allPatients.filter(p => p.equipe === currentTeam);

      if (searchTerm) {
        filteredPatients = filteredPatients.filter(p =>
          p.nome?.toLowerCase().includes(searchTerm) ||
          p.cartao_sus?.includes(searchTerm) ||
          p.telefone?.includes(searchTerm)
        );
      }
      if (microAreaFilter !== 'all') {
        filteredPatients = filteredPatients.filter(p => p.micro_area === microAreaFilter);
      }

      const now = new Date(); now.setHours(0,0,0,0);
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      if (filterValue === 'overdue') {
        filteredPatients = filteredPatients.filter(p => p.data_proxima_visita && new Date(p.data_proxima_visita+'T00:00:00') < now);
      } else if (filterValue === 'this_month') {
        filteredPatients = filteredPatients.filter(p => {
          if (!p.data_proxima_visita) return false;
          const d = new Date(p.data_proxima_visita+'T00:00:00');
          return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
        });
      } else if (filterValue === 'next_month') {
        filteredPatients = filteredPatients.filter(p => {
          if (!p.data_proxima_visita) return false;
          const d = new Date(p.data_proxima_visita+'T00:00:00');
          const nextMonth = (currentMonth + 1) % 12;
          const yearForNextMonth = nextMonth === 0 ? currentYear + 1 : currentYear;
          return d.getMonth() === nextMonth && d.getFullYear() === yearForNextMonth;
        });
      } else if (filterValue === 'no_next_visit') {
        filteredPatients = filteredPatients.filter(p => !p.data_proxima_visita);
      }

      renderPatientList(filteredPatients);
    }

    function displayPatientCard(patient) {
      if (!patient) return;
      detailsHeaderTitle.textContent = patient.nome;

      let overdueHtml = '';
      if (patient.data_proxima_visita) {
        const now = new Date(); now.setHours(0,0,0,0);
        const nextVisitDate = new Date(patient.data_proxima_visita+'T00:00:00');
        if (nextVisitDate < now) {
          const diffTime = Math.abs(now - nextVisitDate);
          const diffDays = Math.ceil(diffTime / (1000*60*60*24));
          overdueHtml = `<p class="overdue-alert">Visita atrasada h√° ${diffDays} dia(s)</p>`;
        }
      }

      const renderTags = (tags) => tags && tags.length > 0
        ? tags.map(t => `<span class="tag-item">${t}</span>`).join('')
        : '<p>Nenhum item.</p>';

      const visitsHtml = patient.visitas && patient.visitas.length > 0
        ? patient.visitas.map(visit => `
            <li class="visit-item">
              <div class="visit-header">
                <span>${new Date(visit.data_visita+'T00:00:00').toLocaleDateString('pt-BR')}</span>
                <strong>${visit.profissional}</strong>
              </div>
              <p class="visit-details">Pr√≥xima por: ${visit.profissional_prox_visita || 'N/D'} em ${visit.data_prox_visita ? new Date(visit.data_prox_visita+'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
              <p class="visit-details"><strong>Obs:</strong> ${visit.observacao || 'Nenhuma'}</p>
            </li>
          `).join('')
        : '<p>Nenhuma visita registrada.</p>';

      const freq = patient.frequencia_visita_meses;
      const freqText = freq ? `${freq} ${freq > 1 ? 'Meses' : 'M√™s'}` : 'N/A';
      const mapLinkHtml = patient.endereco
        ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(patient.endereco+', Bauru, SP')}" target="_blank" class="btn-icon" title="Abrir no mapa">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
           </a>`
        : '';

      patientCardContainer.innerHTML = `
        <div class="patient-card">
          <div class="card-header">
            <h3>${patient.nome}</h3>
            ${overdueHtml}
          </div>
          <div class="card-body">
            <section class="card-section"><h4>Informa√ß√µes B√°sicas</h4>
              <div class="grid-2-cols">
                <p><strong>Equipe:</strong> ${patient.equipe || 'N/A'}</p>
                <p><strong>Status:</strong> ${patient.status || 'N/A'}</p>
                <p><strong>CNS:</strong> ${patient.cartao_sus || 'N/A'}</p>
                <p><strong>Telefone:</strong> ${patient.telefone || 'N/A'}</p>
              </div>
            </section>
            <section class="card-section">
              <div class="section-header-with-action">
                <h4>Localiza√ß√£o</h4>
                ${mapLinkHtml}
              </div>
              <p><strong>Endere√ßo:</strong> ${patient.endereco || 'N/A'}</p>
              <div class="grid-2-cols" style="margin-top:8px">
                <p><strong>√Årea:</strong> ${patient.area || 'N/A'}</p>
                <p><strong>Micro√°rea:</strong> ${patient.micro_area || 'N/A'}</p>
                <p><strong>Fam√≠lia:</strong> ${patient.familia || 'N/A'}</p>
                <p><strong>ACS:</strong> ${patient.agente || 'N/A'}</p>
              </div>
            </section>
            <section class="card-section"><h4>Cuidador</h4><p>${patient.cuidador || 'N/A'}</p></section>
            <section class="card-section"><h4>Motivo do Cadastro</h4><p>${patient.motivo_cadastro || 'N/A'}</p></section>
            <section class="card-section"><h4>Comorbidades</h4><div class="tag-container">${renderTags(patient.comorbidades)}</div></section>
            <section class="card-section"><h4>Medica√ß√µes</h4><div class="tag-container">${renderTags(patient.medicacoes)}</div></section>
            <section class="card-section"><h4>Acompanhamento</h4>
              <div class="grid-2-cols">
                <p><strong>Periodicidade:</strong> ${freqText}</p>
                <p><strong>√öltima Visita:</strong> ${patient.data_ultima_visita ? new Date(patient.data_ultima_visita+'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
                <p><strong>Pr√≥xima Visita:</strong> ${patient.data_proxima_visita ? new Date(patient.data_proxima_visita+'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
                <p><strong>Profissional:</strong> ${patient.profissional_proxima_visita || 'N/A'}</p>
              </div>
            </section>
            <hr style="margin:20px 0">
            <!-- BOT√ïES DE ATENDIMENTO -->
            <section class="card-section" style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn btn-primary" style="width:100%;" onclick="openAtendimentoForm('${patient.id}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                    Atendimento Domiciliar
                </button>
                 <button class="btn btn-info" style="width:100%;" onclick="openAtendimentoRecords('${patient.id}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 8px;"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    Ver Registro de Atendimentos
                </button>
            </section>
            <section class="card-section visits-section">
              <h4><span>Hist√≥rico de Visitas</span>
                <button class="btn btn-info" onclick="openVisitModal('${patient.id}')">+ Visita</button>
              </h4>
              <ul id="visits-list">${visitsHtml}</ul>
            </section>
          </div>
        </div>`;
    }

    async function renderPatientDetails(patientId) {
      const { data: patient, error: pErr } = await db
        .from('pacientes')
        .select('*')
        .eq('id', patientId)
        .single();

      if (pErr || !patient) {
        console.error('Erro ao buscar paciente:', pErr);
        handleDeselectPatient();
        return;
      }
      const { data: visits, error: vErr } = await db
        .from('visitas')
        .select('*')
        .eq('paciente_cartao_sus', patient.cartao_sus)
        .order('data_visita', { ascending: false });

      patient.visitas = vErr ? [] : (visits || []);
      displayPatientCard(patient);
    }

    function handleSelectPatient(patientId) {
      selectedPatientId = patientId;
      mainContainer.classList.add('show-details');
      renderPatientDetails(patientId);
    }
    function handleDeselectPatient() {
      selectedPatientId = null;
      mainContainer.classList.remove('show-details');
      detailsHeaderTitle.textContent = 'Detalhes do Paciente';
      patientCardContainer.innerHTML = '';
    }

    function populateMicroAreaFilter() {
      filterMicroareaSelect.innerHTML = '<option value="all">Todas as Micro√°reas</option>';
      const teamPatients = allPatients.filter(p => p.equipe === currentTeam);
      const microAreas = [...new Set(teamPatients.map(p => p.micro_area).filter(ma => ma))];
      microAreas.sort();
      microAreas.forEach(ma => {
        const option = document.createElement('option');
        option.value = ma;
        option.textContent = `Micro√°rea ${ma}`;
        filterMicroareaSelect.appendChild(option);
      });
    }

    function updateView() {
      applyFiltersAndRenderList();
      updateNotificationBell();
      if (selectedPatientId) {
        const patientExists = allPatients.some(p => p.id === selectedPatientId);
        if (patientExists) renderPatientDetails(selectedPatientId);
        else handleDeselectPatient();
      }
    }

    async function loadDataAndSubscribe() {
      const { data, error } = await db.from('pacientes').select('*').order('nome', { ascending: true });
      if (error) {
        console.error('Erro ao buscar pacientes:', error);
        listPlaceholder.textContent = 'Erro ao carregar dados.';
        return;
      }
      allPatients = data;
      populateMicroAreaFilter();
      updateView();

      if (realtimeChannel) db.removeChannel(realtimeChannel);
      realtimeChannel = db.channel('pacientes_changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'pacientes' }, (payload) => {
            console.log('Realtime update recebido:', payload);
            loadDataAndSubscribe(); // Recarrega tudo para garantir consist√™ncia
        })
        .subscribe();
    }

    async function handleLogin() {
      const email = emailInput.value;
      const password = passwordInput.value;
      loginError.textContent = '';
      loginBtn.disabled = true;
      loginBtn.textContent = 'Entrando...';
      const { error } = await db.auth.signInWithPassword({ email, password });
      if (error) {
        console.error('Erro de login:', error.message);
        loginError.textContent = 'E-mail ou senha inv√°lidos.';
      }
      loginBtn.disabled = false;
      loginBtn.textContent = 'Entrar';
    }

    async function handleLogout() {
      const { error } = await db.auth.signOut();
      if (error) {
        console.error('Erro ao sair:', error);
      }
    }
    
    function closePatientModal() {
        patientModalContainer.classList.remove('visible');
        patientModalContainer.innerHTML = '';
    }

    async function openPatientModal(patientId = null) {
        const isEditing = !!patientId;
        let patient = {};

        if (isEditing) {
            const { data, error } = await db.from('pacientes').select('*').eq('id', patientId).single();
            if (error) {
                console.error("Erro ao buscar paciente para edi√ß√£o", error);
                return;
            }
            patient = data;
        }

        const modalTitle = isEditing ? 'Editar Paciente' : 'Novo Paciente';
        const teamForForm = isEditing ? patient.equipe : currentTeam;

        patientModalContainer.innerHTML = `
        <div class="modal-header">
            <h2>${modalTitle}</h2>
            <button class="btn-icon" id="p_cancelar_header">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="p_equipe">Equipe</label>
                 <select id="p_equipe">
                    <option value="71" ${teamForForm == '71' ? 'selected' : ''}>Equipe 71</option>
                    <option value="72" ${teamForForm == '72' ? 'selected' : ''}>Equipe 72</option>
                    <option value="76" ${teamForForm == '76' ? 'selected' : ''}>Equipe 76</option>
                </select>
            </div>
            <div class="form-group"> <label for="p_nome">Nome Completo</label> <input type="text" id="p_nome" value="${patient.nome || ''}"> </div>
            <div class="grid-2-cols">
                <div class="form-group"> <label for="p_cartao_sus">CNS</label> <input type="text" id="p_cartao_sus" value="${patient.cartao_sus || ''}"> </div>
                <div class="form-group"> <label for="p_telefone">Telefone</label> <input type="text" id="p_telefone" value="${patient.telefone || ''}"> </div>
            </div>
            <div class="grid-2-cols">
                <div class="form-group">
                    <label for="p_status">Status</label>
                    <select id="p_status">
                        <option value="Ativo" ${patient.status === 'Ativo' ? 'selected' : ''}>Ativo</option>
                        <option value="√ìbito" ${patient.status === '√ìbito' ? 'selected' : ''}>√ìbito</option>
                        <option value="Mudou-se" ${patient.status === 'Mudou-se' ? 'selected' : ''}>Mudou-se</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="p_tipo_atendimento">Tipo de Atendimento</label>
                    <textarea id="p_tipo_atendimento">${patient.tipo_atendimento || ''}</textarea>
                </div>
            </div>
            <div class="form-group"> <label for="p_endereco">Endere√ßo</label> <input type="text" id="p_endereco" value="${patient.endereco || ''}"> </div>
            <div class="grid-2-cols">
                <div class="form-group">
                    <label for="p_area">√Årea</label>
                    <select id="p_area">
                        <option value="" ${!patient.area ? 'selected' : ''}>Selecione</option>
                        <option value="071" ${patient.area == '071' ? 'selected' : ''}>071</option>
                        <option value="072" ${patient.area == '072' ? 'selected' : ''}>072</option>
                        <option value="076" ${patient.area == '076' ? 'selected' : ''}>076</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="p_micro_area">Micro√°rea</label>
                    <select id="p_micro_area">
                        <option value="" ${!patient.micro_area ? 'selected' : ''}>Selecione</option>
                        <option value="01" ${patient.micro_area == '01' ? 'selected' : ''}>01</option>
                        <option value="02" ${patient.micro_area == '02' ? 'selected' : ''}>02</option>
                        <option value="03" ${patient.micro_area == '03' ? 'selected' : ''}>03</option>
                        <option value="04" ${patient.micro_area == '04' ? 'selected' : ''}>04</option>
                        <option value="05" ${patient.micro_area == '05' ? 'selected' : ''}>05</option>
                        <option value="06" ${patient.micro_area == '06' ? 'selected' : ''}>06</option>
                    </select>
                </div>
            </div>
            <div class="grid-2-cols">
                <div class="form-group">
                    <label for="p_familia">Fam√≠lia</label>
                    <input type="text" id="p_familia" value="${patient.familia || ''}">
                </div>
                 <div class="form-group">
                    <label for="p_agente">ACS</label>
                    <input type="text" id="p_agente" value="${patient.agente || ''}">
                </div>
            </div>
             <div class="form-group">
                <label for="p_cuidador">Cuidador</label>
                <input type="text" id="p_cuidador" value="${patient.cuidador || ''}">
            </div>
            <div class="form-group">
                <label for="p_motivo_cadastro">Motivo do Cadastro</label>
                <textarea id="p_motivo_cadastro">${patient.motivo_cadastro || ''}</textarea>
            </div>
            <div class="form-group">
                <label for="p_frequencia">Periodicidade Visita</label>
                <select id="p_frequencia">
                    <option value="" ${!patient.frequencia_visita_meses ? 'selected' : ''}>N√£o definida</option>
                    <option value="1" ${patient.frequencia_visita_meses == 1 ? 'selected' : ''}>1 M√™s</option>
                    <option value="2" ${patient.frequencia_visita_meses == 2 ? 'selected' : ''}>2 Meses</option>
                    <option value="3" ${patient.frequencia_visita_meses == 3 ? 'selected' : ''}>3 Meses</option>
                    <option value="4" ${patient.frequencia_visita_meses == 4 ? 'selected' : ''}>4 Meses</option>
                    <option value="6" ${patient.frequencia_visita_meses == 6 ? 'selected' : ''}>6 Meses</option>
                    <option value="12" ${patient.frequencia_visita_meses == 12 ? 'selected' : ''}>12 Meses</option>
                </select>
            </div>
            <div class="form-group">
                <label for="p_comorbidades_input">Comorbidades</label>
                <div id="p_comorbidades_tags" class="tag-input-container"></div>
                <input type="text" id="p_comorbidades_input" placeholder="Digite e aperte Enter para adicionar">
                <div id="p_comorbidades_suggestions" class="suggestions-container"></div>
            </div>
            <div class="form-group">
                <label for="p_medicacoes_input">Medica√ß√µes</label>
                <div id="p_medicacoes_tags" class="tag-input-container"></div>
                <input type="text" id="p_medicacoes_input" placeholder="Digite e aperte Enter para adicionar">
                <div id="p_medicacoes_suggestions" class="suggestions-container"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="p_cancelar" class="btn btn-danger">Cancelar</button>
            <button id="p_salvar" class="btn btn-success">Salvar</button>
        </div>`;
        patientModalContainer.classList.add('visible');
        
        const setupTagInput = (inputId, tagsContainerId, suggestionsContainerId, suggestionsArray) => {
            const input = document.getElementById(inputId);
            const tagsContainer = document.getElementById(tagsContainerId);
            const suggestionsContainer = document.getElementById(suggestionsContainerId);

            const addTag = (text) => {
                const tagContent = text.trim();
                if (tagContent.length < 1) return;
                
                const existingTags = [...tagsContainer.querySelectorAll('span')].map(t => t.textContent);
                if (existingTags.includes(tagContent)) {
                    input.value = '';
                    return;
                }

                const tagEl = document.createElement('div');
                tagEl.className = 'tag-input-item';
                tagEl.innerHTML = `<span>${tagContent}</span><button class="remove-tag-btn">&times;</button>`;
                tagEl.querySelector('.remove-tag-btn').addEventListener('click', () => tagEl.remove());
                tagsContainer.appendChild(tagEl);
                input.value = '';
            };

            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag(input.value);
                }
            });

            suggestionsContainer.innerHTML = suggestionsArray.map(s => `<button class="suggestion-btn">${s}</button>`).join('');
            suggestionsContainer.querySelectorAll('.suggestion-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    addTag(e.target.textContent);
                });
            });

            return (existingTags) => {
                tagsContainer.innerHTML = '';
                if(Array.isArray(existingTags)) {
                    existingTags.forEach(tagText => {
                        const tagEl = document.createElement('div');
                        tagEl.className = 'tag-input-item';
                        tagEl.innerHTML = `<span>${tagText}</span><button class="remove-tag-btn">&times;</button>`;
                        tagEl.querySelector('.remove-tag-btn').addEventListener('click', () => tagEl.remove());
                        tagsContainer.appendChild(tagEl);
                    });
                }
            }
        };

        const populateComorbidities = setupTagInput('p_comorbidades_input', 'p_comorbidades_tags', 'p_comorbidades_suggestions', comorbiditySuggestions);
        const populateMedications = setupTagInput('p_medicacoes_input', 'p_medicacoes_tags', 'p_medicacoes_suggestions', medicationSuggestions);

        if(isEditing) {
            populateComorbidities(patient.comorbidades);
            populateMedications(patient.medicacoes);
        }

        document.getElementById('p_cancelar').onclick = closePatientModal;
        document.getElementById('p_cancelar_header').onclick = closePatientModal;
        document.getElementById('p_salvar').onclick = async () => {
            const saveButton = document.getElementById('p_salvar');
            
            const getTags = (containerId) => [...document.querySelectorAll(`#${containerId} .tag-input-item span`)].map(span => span.textContent);

            const patientData = {
                nome: document.getElementById('p_nome').value.trim(),
                cartao_sus: document.getElementById('p_cartao_sus').value.trim(),
                telefone: document.getElementById('p_telefone').value.trim(),
                endereco: document.getElementById('p_endereco').value.trim(),
                area: document.getElementById('p_area').value,
                micro_area: document.getElementById('p_micro_area').value,
                familia: document.getElementById('p_familia').value.trim() || null,
                agente: document.getElementById('p_agente').value.trim(),
                cuidador: document.getElementById('p_cuidador').value.trim(),
                motivo_cadastro: document.getElementById('p_motivo_cadastro').value.trim(),
                status: document.getElementById('p_status').value,
                tipo_atendimento: document.getElementById('p_tipo_atendimento').value.trim(),
                frequencia_visita_meses: parseInt(document.getElementById('p_frequencia').value) || null,
                comorbidades: getTags('p_comorbidades_tags'),
                medicacoes: getTags('p_medicacoes_tags'),
                equipe: document.getElementById('p_equipe').value
            };
            
            if (!patientData.nome || !patientData.cartao_sus) {
                showMessageModal("Os campos 'Nome Completo' e 'CNS' s√£o obrigat√≥rios.");
                return;
            }
            
            saveButton.disabled = true;
            saveButton.textContent = 'Salvando...';

            const { data: existingPatient, error: checkError } = await db
                .from('pacientes')
                .select('*') 
                .eq('cartao_sus', patientData.cartao_sus)
                .single();

            if (checkError && checkError.code !== 'PGRST116') {
                 console.error("Erro ao checar CNS existente:", checkError);
                 showMessageModal("Ocorreu um erro ao verificar o CNS. Tente novamente.");
                 saveButton.disabled = false;
                 saveButton.textContent = 'Salvar';
                 return;
            }

            if (isEditing) {
                if (existingPatient && existingPatient.id !== patientId) {
                    showConfirmationModal(
                        `O CNS informado j√° pertence a(o) paciente ${existingPatient.nome}. Deseja que os dados atuais sobrescrevam o cadastro dele? O paciente que voc√™ estava editando (${patient.nome}) ser√° removido.`,
                        async () => {
                            const { error: updateError } = await db.from('pacientes').update(patientData).eq('id', existingPatient.id);
                            if (updateError) {
                                showMessageModal("Ocorreu um erro ao sobrescrever os dados do paciente.");
                                console.error("Erro ao sobrescrever:", updateError);
                                return;
                            }
                            const { error: deleteError } = await db.from('pacientes').delete().eq('id', patientId);
                            if (deleteError) {
                                showMessageModal("Dados sobrescritos, mas ocorreu um erro ao remover o cadastro antigo. Por favor, remova-o manualmente.");
                                console.error("Erro ao deletar paciente antigo:", deleteError);
                            }
                            
                            closePatientModal();
                            handleDeselectPatient();
                            await loadDataAndSubscribe();
                        }
                    );
                    saveButton.disabled = false;
                    saveButton.textContent = 'Salvar';
                } else {
                    const { error: updateError } = await db.from('pacientes').update(patientData).eq('id', patientId);
                    if (updateError) {
                         console.error("Erro ao atualizar paciente", updateError);
                         showMessageModal("Ocorreu um erro ao atualizar. Verifique os dados e tente novamente.");
                         saveButton.disabled = false;
                         saveButton.textContent = 'Salvar';
                    } else {
                         closePatientModal();
                         await renderPatientDetails(patientId);
                         await loadDataAndSubscribe();
                    }
                }
            } else {
                if (existingPatient) {
                    showConfirmationModal(
                        `J√° existe um paciente (${existingPatient.nome}) com este CNS. Deseja sobrescrever os dados dele com as novas informa√ß√µes?`,
                        async () => {
                            const { error: updateError } = await db.from('pacientes').update(patientData).eq('id', existingPatient.id);
                            if (updateError) {
                                showMessageModal("Ocorreu um erro ao sobrescrever os dados do paciente.");
                                console.error("Erro ao sobrescrever:", updateError);
                            } else {
                                closePatientModal();
                                await loadDataAndSubscribe();
                            }
                        }
                    );
                    saveButton.disabled = false;
                    saveButton.textContent = 'Salvar';
                } else {
                    const { error: insertError } = await db.from('pacientes').insert([patientData]);
                    if (insertError) {
                         console.error("Erro ao criar paciente", insertError);
                         showMessageModal("Ocorreu um erro ao criar o paciente. Verifique os dados e tente novamente.");
                         saveButton.disabled = false;
                         saveButton.textContent = 'Salvar';
                    } else {
                        closePatientModal();
                        await loadDataAndSubscribe();
                    }
                }
            }
        };
    }

    function openMoreOptionsModal() {
      moreOptionsModalContainer.innerHTML = `
        <div class="modal-header">
          <h2>Mais Op√ß√µes</h2>
          <button class="btn-icon" onclick="closeMoreOptionsModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
        <div class="modal-body">
          <button id="logout-btn-modal" class="btn btn-danger">Sair do Sistema</button>
        </div>`;
      moreOptionsModalContainer.classList.add('visible');
      document.getElementById('logout-btn-modal').addEventListener('click', () => {
        closeMoreOptionsModal();
        handleLogout();
      });
    }

    async function openVisitModal(patientId) {
      const { data: patient, error } = await db
        .from('pacientes')
        .select('id, nome, cartao_sus')
        .eq('id', patientId)
        .single();

      if (error || !patient) {
        showMessageModal('N√£o foi poss√≠vel carregar o paciente para registrar a visita.');
        console.error(error);
        return;
      }

      visitModalContainer.innerHTML = `
        <div class="modal-header">
          <h2>Nova Visita ‚Äî ${patient.nome}</h2>
          <button class="btn-icon" onclick="closeVisitModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="v_data_visita">Data da visita</label>
            <input type="date" id="v_data_visita" value="${new Date().toISOString().split('T')[0]}">
          </div>
          <div class="form-group">
            <label for="v_profissional">Profissional</label>
            <input type="text" id="v_profissional" placeholder="Ex.: Enfermeiro(a) Fernanda, ACS Ricardo...">
          </div>
          <div class="form-group">
            <label for="v_data_prox">Pr√≥xima visita (opcional)</label>
            <input type="date" id="v_data_prox">
          </div>
          <div class="form-group">
            <label for="v_prof_prox">Profissional da pr√≥xima (opcional)</label>
            <input type="text" id="v_prof_prox" placeholder="Ex.: M√©dico Gabriel, ACS Vanessa...">
          </div>
          <div class="form-group">
            <label for="v_obs">Observa√ß√£o</label>
            <textarea id="v_obs" placeholder="Conduta, achados, orienta√ß√µes..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button id="v_cancelar" class="btn btn-danger">Cancelar</button>
          <button id="v_salvar" class="btn btn-success">Salvar</button>
        </div>
      `;
      visitModalContainer.classList.add('visible');

      document.getElementById('v_cancelar').onclick = () => closeVisitModal();
      document.getElementById('v_salvar').onclick = async () => {
        const data_visita = document.getElementById('v_data_visita').value;
        const profissional = document.getElementById('v_profissional').value.trim();
        const data_prox_visita = document.getElementById('v_data_prox').value || null;
        const profissional_prox_visita = document.getElementById('v_prof_prox').value.trim() || null;
        const observacao = document.getElementById('v_obs').value.trim() || null;

        if (!data_visita || !profissional) {
          showMessageModal('Preencha ao menos Data da visita e Profissional.');
          return;
        }

        const { error: insertErr } = await db.from('visitas').insert({
          paciente_cartao_sus: patient.cartao_sus,
          data_visita,
          profissional,
          data_prox_visita,
          profissional_prox_visita,
          observacao
        });

        if (insertErr) {
          showMessageModal('Erro ao salvar visita.');
          console.error(insertErr);
          return;
        }

        const updates = { data_ultima_visita: data_visita };
        if (data_prox_visita) updates.data_proxima_visita = data_prox_visita;
        if (profissional_prox_visita) updates.profissional_proxima_visita = profissional_prox_visita;

        const { error: upErr } = await db
          .from('pacientes')
          .update(updates)
          .eq('id', patientId);

        if (upErr) console.warn('Visita salva, mas n√£o atualizou o paciente:', upErr);

        closeVisitModal();
        await renderPatientDetails(patientId);
        await loadDataAndSubscribe();
      };
    };

    function closeVisitModal() {
      visitModalContainer.classList.remove('visible');
      visitModalContainer.innerHTML = '';
    };

    function closeMoreOptionsModal() {
      moreOptionsModalContainer.classList.remove('visible');
      moreOptionsModalContainer.innerHTML = '';
    };

    window.openVisitModal = openVisitModal;
    window.closeVisitModal = closeVisitModal;
    window.openPatientModal = openPatientModal;
    window.closePatientModal = closePatientModal;
    window.closeMoreOptionsModal = closeMoreOptionsModal;
    window.openAtendimentoForm = openAtendimentoForm;
    window.openAtendimentoRecords = openAtendimentoRecords;
    window.closeAtendimentoModal = closeAtendimentoModal;
    window.startSpeechRecognition = startSpeechRecognition;
    window.closeAtendimentoRecordsModal = closeAtendimentoRecordsModal;
    window.openExportModal = openExportModal;
    window.closeExportModal = closeExportModal;


    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      document.body.innerHTML = `<div style="padding:20px;text-align:center"><h2>CONFIGURA√á√ÉO INCOMPLETA</h2><p>Insira suas chaves do Supabase no c√≥digo.</p></div>`;
    } else {
      db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('Supabase conectado!');

      db.auth.onAuthStateChange((event, session) => {
        const user = session?.user;
        if (user) {
          loginView.style.display = 'none';
          mainContainer.style.display = 'flex';
          addPatientBtn.disabled = false;
          loadDataAndSubscribe();
        } else {
          mainContainer.style.display = 'none';
          loginView.style.display = 'flex';
          addPatientBtn.disabled = true;
          if (realtimeChannel) {
            db.removeChannel(realtimeChannel);
            realtimeChannel = null;
          }
          allPatients = [];
          updateView();
        }
      });

      // Eventos
      loginBtn.addEventListener('click', handleLogin);
      passwordInput.addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
      emailInput.addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
      
      addPatientBtn.addEventListener('click', () => openPatientModal());
      headerAddPatientBtn.addEventListener('click', () => openPatientModal());
      editPatientBtn.addEventListener('click', () => {
          if (selectedPatientId) {
              openPatientModal(selectedPatientId);
          }
      });
      
      deletePatientBtn.addEventListener('click', () => {
          if (selectedPatientId) {
            showConfirmationModal('Tem certeza que deseja excluir este paciente? Esta a√ß√£o n√£o pode ser desfeita.', async () => {
              const { error } = await db.from('pacientes').delete().eq('id', selectedPatientId);
              if(error) {
                  console.error('Erro ao excluir:', error);
                  showMessageModal('N√£o foi poss√≠vel excluir o paciente.');
              } else {
                  handleDeselectPatient();
                  loadDataAndSubscribe();
              }
            });
          }
      });

      backToListBtn.addEventListener('click', handleDeselectPatient);
      searchInput.addEventListener('input', updateView);
      filterSelect.addEventListener('change', updateView);
      filterMicroareaSelect.addEventListener('change', updateView);
      teamTabs.addEventListener('click', e => {
        if (e.target.classList.contains('tab') && !e.target.classList.contains('active')) {
          currentTeam = e.target.dataset.team;
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          e.target.classList.add('active');
          handleDeselectPatient();
          populateMicroAreaFilter();
          updateView();
        }
      });
      moreOptionsBtn.addEventListener('click', openMoreOptionsModal);
      exportBtn.addEventListener('click', openExportModal);
    }
  </script>
</body>
</html>

